<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mega Millions Quantum Lotto Tracker</title>
  <style>
    body { background: #1e2127; color: #fff; font-family: sans-serif; max-width:540px; margin:3em auto; padding: 2em;}
    button { font-size: 1.1em; padding: 0.7em 2em; border-radius: 8px;}
    .nums { font-size: 1.3em; margin:1em; }
    .ball {
      display: inline-flex; align-items: center; justify-content: center;
      width:2em; height:2em; line-height:2em;
      background: #fafafa; color:#222; border-radius:50%; font-weight:bold;
      margin: 0.12em 0.18em; box-shadow:0 2px 9px #0006; border: 2.5px solid #cadaee;
      font-size: 1em; text-align: center;
    }
    .mega {
      background: #ffd600 !important;
      color: #232100 !important;
      border: 2.5px solid #ffe970 !important;
    }
    .log { background:#2b2f3a; margin: 1em 0; border-radius:6px; padding: 1em; }
    .logtime { color:#fea340; font-size:0.95em;}
    .cooldown { color:#ffd600; font-size:1.06em; margin-top:0.3em;}
    .uploader { margin: 1.5em 0;}
    input[type="file"] {color:#fff;}
  </style>
</head>
<body>
  <h2>Mega Millions Quantum Lotto Tracker (Browser Only)</h2>
  <button id="getBtn" onclick="getTicket()">Generate Quantum Ticket</button>
  <div class="cooldown" id="cooldown"></div>
  <div id="curr"></div>
  <button id="buyBtn" onclick="buyTicket()" style="display:none">Buy This Ticket</button>
  <div class="uploader">
    <button onclick="saveHistory()">Save History</button>
    <label style="display:inline-block">
      <input type="file" id="loadInput" style="display:none" onchange="loadHistory(event)">
      <button onclick="document.getElementById('loadInput').click()">Load History</button>
    </label>
  </div>
  <h3>Saved Tickets:</h3>
  <div id="history"></div>
<script>
let currTicket = null;
let cooldownEnd = null;
let cooldownTimer = null;

function startCooldown() {
  cooldownEnd = Date.now() + 60 * 1000; // 1 minute from now
  document.getElementById('getBtn').disabled = true;
  updateCooldown();
  if (cooldownTimer) clearInterval(cooldownTimer);
  cooldownTimer = setInterval(updateCooldown, 175);
}
function updateCooldown() {
  if (!cooldownEnd) return;
  let ms = cooldownEnd - Date.now();
  if (ms <= 0) {
    clearInterval(cooldownTimer);
    cooldownTimer = null;
    cooldownEnd = null;
    document.getElementById('cooldown').textContent = '';
    document.getElementById('getBtn').disabled = false;
    return;
  }
  let s = Math.ceil(ms / 1000);
  document.getElementById('cooldown').textContent =
    `Please wait ${s} second${s !== 1 ? 's' : ''} before next ticket.`;
}

async function getTicket() {
  document.getElementById('curr').innerHTML = "Getting quantum numbers from ANU QRNG...";
  document.getElementById('buyBtn').style.display = "none";
  startCooldown();
  try {
    let resp = await fetch('https://qrng.anu.edu.au/API/jsonI.php?length=10&type=uint16');
    let data = await resp.json();
    if (!data.success) throw "Quantum error";
    let d = data.data;
    let nums = [], i = 0;
    while (nums.length < 5 && i < d.length) {
      let n = Math.floor((d[i] / 65535) * 70) + 1;
      if (!nums.includes(n)) nums.push(n);
      i++;
    }
    if (nums.length < 5) throw "Too few unique numbers, try again!";
    let mega = Math.floor((d[d.length-1] / 65535) * 25) + 1;
    currTicket = {numbers: nums, mega: mega};
    document.getElementById('curr').innerHTML =
      `<div class="nums">
        <b>White Balls:</b> ${nums.sort((a,b)=>a-b).map(x=>`<span class="ball">${x}</span>`).join('')}
        <br><b>Mega Ball:</b> <span class="ball mega">${mega}</span>
      </div>`;
    document.getElementById('buyBtn').style.display = "inline-block";
  } catch (e) {
    document.getElementById('curr').innerHTML = "<b>Quantum QRNG errorâ€”try again!</b>";
  }
}

function buyTicket() {
  if (!currTicket) return;
  let logs = JSON.parse(localStorage.getItem('lottoLog')||'[]');
  logs.push({
    numbers: currTicket.numbers,
    mega: currTicket.mega,
    ts: new Date().toISOString()
  });
  localStorage.setItem('lottoLog', JSON.stringify(logs));
  showHistory();
  document.getElementById('buyBtn').style.display = "none";
  document.getElementById('curr').innerHTML = "<b>Ticket logged!</b>";
}

function showHistory() {
  let logs = JSON.parse(localStorage.getItem('lottoLog')||'[]');
  document.getElementById('history').innerHTML =
    logs.length ?
      logs.map(
        l => `<div class="log">
          <span class="logtime">${new Date(l.ts).toLocaleString()}</span>
          <br><b>White Balls:</b> ${l.numbers.sort((a,b)=>a-b).map(x=>`<span class="ball">${x}</span>`).join('')}
          <br><b>Mega Ball:</b> <span class="ball mega">${l.mega}</span>
        </div>`).join("")
      : "<i>No tickets saved yet.</i>";
}

// --- New features below ---

// Save localStorage history to download
function saveHistory() {
  let logs = JSON.parse(localStorage.getItem('lottoLog')||'[]');
  let blob = new Blob([JSON.stringify(logs, null, 2)], {type: 'application/json'});
  let a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'lotto-history.json';
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{document.body.removeChild(a);}, 200);
}

// Load history file and overwrite local history
function loadHistory(event) {
  let file = event.target.files[0];
  if (!file) return;
  let reader = new FileReader();
  reader.onload = function(e) {
    try {
      let logs = JSON.parse(e.target.result);
      localStorage.setItem('lottoLog', JSON.stringify(logs));
      showHistory();
      alert("History loaded successfully!");
    } catch {
      alert("Invalid or corrupt history file.");
    }
  };
  reader.readAsText(file);
}

window.onload = showHistory;
</script>
</body>
</html>
