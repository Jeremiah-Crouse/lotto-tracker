<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mega Millions Quantum Lotto Tracker (with QRNG Stack)</title>
  <style>
    body { background: #1e2127; color: #fff; font-family: sans-serif; max-width:540px; margin:3em auto; padding: 2em;}
    button { font-size: 1.1em; padding: 0.7em 2em; border-radius: 8px;}
    .nums { font-size: 1.3em; margin:1em; }
    .ball {
      display: inline-flex; align-items: center; justify-content: center;
      width:2em; height:2em; line-height:2em;
      background: #fafafa; color:#222; border-radius:50%; font-weight:bold;
      margin: 0.12em 0.18em; box-shadow:0 2px 9px #0006; border: 2.5px solid #cadaee;
      font-size: 1em; text-align: center;
    }
    .mega {
      background: #ffd600 !important;
      color: #232100 !important;
      border: 2.5px solid #ffe970 !important;
    }
    .log { background:#2b2f3a; margin: 1em 0; border-radius:6px; padding: 1em; }
    .logtime { color:#fea340; font-size:0.95em;}
    .uploader { margin: 1.5em 0;}
    input[type="file"] {color:#fff;}
    .small { color:#ffd600; font-size:1.1em; }
  </style>
</head>
<body>
  <h2>Mega Millions Quantum Lotto Tracker (QRNG Stack)</h2>
  <button id="getBtn" onclick="getTicket()">Generate Quantum Ticket</button>
  <span class="small" id="stackinfo"></span>
  <div id="curr"></div>
  <button id="buyBtn" onclick="buyTicket()" style="display:none">Buy This Ticket</button>
  <div class="uploader">
    <button onclick="saveHistory()">Save History</button>
    <label style="display:inline-block">
      <input type="file" id="loadInput" style="display:none" onchange="loadHistory(event)">
      <button onclick="document.getElementById('loadInput').click()">Load History</button>
    </label>
    <button onclick="clearHistory()">Clear History</button>
  </div>
  <h3>Saved Tickets:</h3>
  <div id="history"></div>
<script>
let currTicket = null;
let quantumStack = [];
const STACKSIZE = 1024;

async function refillQuantumStack() {
  document.getElementById('stackinfo').textContent = " — Loading quantum numbers...";
  try {
    let resp = await fetch(`https://qrng.anu.edu.au/API/jsonI.php?length=${STACKSIZE}&type=uint16`);
    let data = await resp.json();
    if (data.success) {
      quantumStack = quantumStack.concat(data.data);
      document.getElementById('stackinfo').textContent = ` — QRNG stack size: ${quantumStack.length}`;
    } else throw "Quantum QRNG error";
  } catch (e) {
    document.getElementById('stackinfo').textContent = " — Quantum QRNG error!";
  }
}

async function getTicket() {
  document.getElementById('curr').innerHTML = "Drawing from quantum stack...";
  document.getElementById('buyBtn').style.display = "none";
  // Refill if needed (async, doesn't block current batch, just guarantees new numbers for future draws)
  if (quantumStack.length < 20) refillQuantumStack();
  // If somehow totally run out, force wait
  while (quantumStack.length < 6) {
    await refillQuantumStack();
  }
  // Draw numbers from stack
  let nums = [], i = 0;
  while (nums.length < 5 && i < quantumStack.length) {
    let n = Math.floor((quantumStack[i] / 65535) * 70) + 1;
    if (!nums.includes(n)) nums.push(n);
    i++;
  }
  quantumStack = quantumStack.slice(i); // remove consumed numbers
  if (nums.length < 5) {
    document.getElementById('curr').innerHTML = "<b>Not enough unique numbers, try again!</b>";
    return;
  }
  let mega = Math.floor((quantumStack[0] / 65535) * 25) + 1;
  quantumStack.shift();
  currTicket = {numbers: nums, mega: mega};
  document.getElementById('curr').innerHTML =
    `<div class="nums">
      <b>White Balls:</b> ${nums.sort((a,b)=>a-b).map(x=>`<span class="ball">${x}</span>`).join('')}
      <br><b>Mega Ball:</b> <span class="ball mega">${mega}</span>
    </div>`;
  document.getElementById('buyBtn').style.display = "inline-block";
  document.getElementById('stackinfo').textContent = ` — QRNG stack size: ${quantumStack.length}`;
}

function buyTicket() {
  if (!currTicket) return;
  let logs = JSON.parse(localStorage.getItem('lottoLog')||'[]');
  logs.push({
    numbers: currTicket.numbers,
    mega: currTicket.mega,
    ts: new Date().toISOString()
  });
  localStorage.setItem('lottoLog', JSON.stringify(logs));
  showHistory();
  document.getElementById('buyBtn').style.display = "none";
  document.getElementById('curr').innerHTML = "<b>Ticket logged!</b>";
}

function showHistory() {
  let logs = JSON.parse(localStorage.getItem('lottoLog')||'[]');
  document.getElementById('history').innerHTML =
    logs.length ?
      logs.map(
        l => `<div class="log">
          <span class="logtime">${new Date(l.ts).toLocaleString()}</span>
          <br><b>White Balls:</b> ${l.numbers.sort((a,b)=>a-b).map(x=>`<span class="ball">${x}</span>`).join('')}
          <br><b>Mega Ball:</b> <span class="ball mega">${l.mega}</span>
        </div>`).join("")
      : "<i>No tickets saved yet.</i>";
}

// --- Save/Load/Clear History ---
function saveHistory() {
  let logs = JSON.parse(localStorage.getItem('lottoLog')||'[]');
  let blob = new Blob([JSON.stringify(logs, null, 2)], {type: 'application/json'});
  let a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'lotto-history.json';
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{document.body.removeChild(a);}, 200);
}
function loadHistory(event) {
  let file = event.target.files[0];
  if (!file) return;
  let reader = new FileReader();
  reader.onload = function(e) {
    try {
      let logs = JSON.parse(e.target.result);
      if (!Array.isArray(logs)) throw "Bad file";
      localStorage.setItem('lottoLog', JSON.stringify(logs));
      showHistory();
      alert("History loaded successfully!");
    } catch {
      alert("Invalid or corrupt history file.");
    }
  };
  reader.readAsText(file);
}
function clearHistory() {
  localStorage.removeItem('lottoLog');
  showHistory();
  document.getElementById('curr').innerHTML = "";
  document.getElementById('buyBtn').style.display = "none";
}

window.onload = async function() {
  await refillQuantumStack();
  showHistory();
};
</script>
</body>
</html>
